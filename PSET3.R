#PSET3#
rm(list = ls())
#usamos la libreria
library("pacman")


rm(list = ls())

require("sf")

p_load(tidyverse,
       sf,
       rio,
       leaflet,
       tmaptools,
       osmdata)


#Cargamos las bases
train <- readRDS("C:/Users/pcere/Dropbox/Machine Learning/PSET3/dataPS3/dataPS3/train.Rds")

test <- readRDS("C:/Users/pcere/Dropbox/Machine Learning/PSET3/dataPS3/dataPS3/test.Rds")

#############################3333
#Agregamos variables con análisis de textos

#convertir todo el texto en minusculas

train$description <- tolower(train$description)

#quitar tildes

train$description <- iconv(train$description, from = "UTF-8", to = "ASCII//TRANSLIT")


#elimnar caracter especial

train$description <- str_replace_all(train$description, "[^[:alnum:]]", " ")


#eliminamos espacios extras

train$description <- gsub("\\s+", " ", str_trim(train$description))

typos <- aregexec("garajes", train$description)
regmatches(train$description, typos)

#contamos para ver con cuantos nas contamos

sum(is.na(train$description))

# eliminamos los na

train <- train[!is.na(train$description),]

#creamos nuevas variables del texto

#conjunto residencial

train <- train %>% mutate(conjunto = str_detect(train$description, "conjunto"))

#ascensor
train <- train %>% mutate(ascensor = str_detect(train$description, "ascensor"))
train <- train %>% mutate(ascensor1 = str_detect(train$description, "acensor"))
train <- train %>% mutate(ascensor2 = str_detect(train$description, "asensor"))

#garaje
train <- train %>% mutate(garaje = str_detect(train$description, "garaje"))
train <- train %>% mutate(garaje1 = str_detect(train$description, "garage"))
train <- train %>% mutate(garaje2 = str_detect(train$description, "garages"))
train <- train %>% mutate(garaje3 = str_detect(train$description, "garajes"))
train <- train %>% mutate(garaje4 = str_detect(train$description, "garje"))
train <- train %>% mutate(garaje5 = str_detect(train$description, "garge"))

#amoblado
train <- train %>% mutate(amoblado = str_detect(train$description, "amoblado"))
train <- train %>% mutate(amoblado1 = str_detect(train$description, "amoblada"))
train <- train %>% mutate(amoblado2 = str_detect(train$description, "amovlada"))                
train <- train %>% mutate(amoblado3 = str_detect(train$description, "amovlado"))

#convertir los true en 1 y 0

train <- train %>%
  mutate(conjunto1 = ifelse(conjunto=="TRUE", 1,0),
         ascensor6 = ifelse(ascensor=="TRUE", 1,0),
         ascensor7 = ifelse(ascensor1=="TRUE", 1,0),
         ascensor8 = ifelse(ascensor2=="TRUE", 1,0),
         garaje6 = ifelse(garaje=="TRUE", 1,0),
         garaje7 = ifelse(garaje1=="TRUE", 1,0),
         garaje8 = ifelse(garaje2=="TRUE", 1,0),
         garaje9 = ifelse(garaje3=="TRUE", 1,0),
         garaje10 = ifelse(garaje4=="TRUE", 1,0),
         garaje11 = ifelse(garaje5=="TRUE", 1,0),
         amoblado4 = ifelse(amoblado=="TRUE", 1,0),
         amoblado5 = ifelse(amoblado1=="TRUE", 1,0),
         amoblado6 = ifelse(amoblado2=="TRUE", 1,0),
         amoblado7 = ifelse(amoblado3=="TRUE", 1,0))

#sumarlos y dejar listas las variables

train <- train %>% mutate(ascensor9 = ascensor6 + ascensor7 + ascensor8)
train <- train %>% mutate(garaje12 = garaje6 + garaje7 + garaje8 + garaje9 + garaje10 + garaje11)
train <- train %>% mutate(amoblado8 = amoblado4 + amoblado5 + amoblado6 + amoblado7 )


table(train$amoblado8)
table(train$garaje12)
table(train$conjunto)
table(train$ascensor9)

#cambiar la codificación para que queden en 1 y 0

#garaje
train$garaje12[train$garaje12 == 2] <- 1
train$garaje12[train$garaje12 == 3] <- 1
train$garaje12[train$garaje12 == 4] <- 1

#ascensor

train$ascensor9[train$ascensor == 2] <- 1


#eliminar columnas que ya no se necesitan 

train$global = NULL
train$conjunto1 = NULL
train$ascensor = NULL
train$ascensor1 = NULL
train$ascensor2 = NULL
train$ascensor3 = NULL
train$ascensor6 = NULL
train$ascensor7= NULL
train$ascensor8 = NULL
train$garaje = NULL
train$garaje1 = NULL
train$garaje2 = NULL
train$garaje3 = NULL
train$garaje4 = NULL
train$garaje5 = NULL
train$garaje6 = NULL
train$garaje7 = NULL
train$garaje8 = NULL
train$garaje9 = NULL
train$garaje10 = NULL
train$garaje11 = NULL
train$amoblado = NULL
train$amoblado1 = NULL
train$amoblado2 = NULL
train$amoblado3 = NULL
train$amoblado4 = NULL
train$amoblado5 = NULL
train$amoblado6 = NULL
train$amoblado7 = NULL


####################


######################################################
# test

####################

#Ponemos sistema de coordenadas para los aptos

install.packages("stringr")
library(stringr)



#convertir todo el texto en minusculas


test$description <- tolower(test$description)

#quitar tildes

test$description <- iconv(test$description, from = "UTF-8", to = "ASCII//TRANSLIT")


#elimnar caracter especial

test$description <- str_replace_all(test$description, "[^[:alnum:]]", " ")


#eliminamos espacios extras

test$description <- gsub("\\s+", " ", str_trim(test$description))

typos <- aregexec("garajes", test$description)
regmatches(test$description, typos)

#contamos para ver con cuantos nas contamos

sum(is.na(test$description))

# eliminamos los na

test <- test[!is.na(test$description),]

#creamos nuevas variables del texto

#conjunto residencial

test <- test %>% mutate(conjunto = str_detect(test$description, "conjunto"))

#ascensor
test <- test %>% mutate(ascensor = str_detect(test$description, "ascensor"))
test <- test %>% mutate(ascensor1 = str_detect(test$description, "acensor"))
test <- test %>% mutate(ascensor2 = str_detect(test$description, "asensor"))

#garaje
test <- test %>% mutate(garaje = str_detect(test$description, "garaje"))
test <- test %>% mutate(garaje1 = str_detect(test$description, "garage"))
test <- test %>% mutate(garaje2 = str_detect(test$description, "garages"))
test <- test %>% mutate(garaje3 = str_detect(test$description, "garajes"))
test <- test %>% mutate(garaje4 = str_detect(test$description, "garje"))
test <- test %>% mutate(garaje5 = str_detect(test$description, "garge"))

#amoblado
test <- test %>% mutate(amoblado = str_detect(test$description, "amoblado"))
test <- test %>% mutate(amoblado1 = str_detect(test$description, "amoblada"))
test <- test %>% mutate(amoblado2 = str_detect(test$description, "amovlada"))                
test <- test %>% mutate(amoblado3 = str_detect(test$description, "amovlado"))

#convertir los true en 1 y 0

test <- test %>%
  mutate(conjunto1 = ifelse(conjunto=="TRUE", 1,0),
         ascensor6 = ifelse(ascensor=="TRUE", 1,0),
         ascensor7 = ifelse(ascensor1=="TRUE", 1,0),
         ascensor8 = ifelse(ascensor2=="TRUE", 1,0),
         garaje6 = ifelse(garaje=="TRUE", 1,0),
         garaje7 = ifelse(garaje1=="TRUE", 1,0),
         garaje8 = ifelse(garaje2=="TRUE", 1,0),
         garaje9 = ifelse(garaje3=="TRUE", 1,0),
         garaje10 = ifelse(garaje4=="TRUE", 1,0),
         garaje11 = ifelse(garaje5=="TRUE", 1,0),
         amoblado4 = ifelse(amoblado=="TRUE", 1,0),
         amoblado5 = ifelse(amoblado1=="TRUE", 1,0),
         amoblado6 = ifelse(amoblado2=="TRUE", 1,0),
         amoblado7 = ifelse(amoblado3=="TRUE", 1,0))

#sumarlos y dejar listas las variables

test <- test %>% mutate(ascensor9 = ascensor6 + ascensor7 + ascensor8)
test <- test %>% mutate(garaje12 = garaje6 + garaje7 + garaje8 + garaje9 + garaje10 + garaje11)
test <- test %>% mutate(amoblado8 = amoblado4 + amoblado5 + amoblado6 + amoblado7 )


table(test$amoblado8)
table(test$garaje12)
table(test$conjunto)
table(test$ascensor9)

#cambiar la codificación para que queden en 1 y 0

#garaje
test$garaje12[test$garaje12 == 2] <- 1
test$garaje12[test$garaje12 == 3] <- 1
test$garaje12[test$garaje12 == 4] <- 1

#ascensor

test$ascensor9[test$ascensor == 2] <- 1

#eliminar columnas que ya no se necesitan 

test$global = NULL
test$conjunto1 = NULL
test$ascensor = NULL
test$ascensor1 = NULL
test$ascensor2 = NULL
test$ascensor3 = NULL
test$ascensor6 = NULL
test$ascensor7= NULL
test$ascensor8 = NULL
test$garaje = NULL
test$garaje1 = NULL
test$garaje2 = NULL
test$garaje3 = NULL
test$garaje4 = NULL
test$garaje5 = NULL
test$garaje6 = NULL
test$garaje7 = NULL
test$garaje8 = NULL
test$garaje9 = NULL
test$garaje10 = NULL
test$garaje11 = NULL
test$amoblado = NULL
test$amoblado1 = NULL
test$amoblado2 = NULL
test$amoblado3 = NULL
test$amoblado4 = NULL
test$amoblado5 = NULL
test$amoblado6 = NULL
test$amoblado7 = NULL




db<-data.frame(place= test$property_id,
               lat= test$lat,
               long= test$lon
)
db<-db %>% mutate(latp=lat,longp=long)

db<-st_as_sf(db,coords=c('longp','latp'),crs=4626)


#####
##Sacamos información de el Poblado

base_train_test <- bind_rows(train,test) %>% st_as_sf(coords=c("lon","lat"),crs=4626)

#Definimos sólo el área del poblado
PH_Poblado <- getbb(place_name = "Comuna 14 - El Poblado", 
                 featuretype = "boundary:administrative", 
                 format_out = "sf_polygon") 
#Dejamos con el mismo sistema de coordenadas

st_crs(PH_Poblado)==st_crs(base_train_test$geometry)
PH_Poblado <- st_transform(PH_Poblado, crs=st_crs(base_train_test$geometry))


# Observaciones en el poblado 
Pobladation <- base_train_test[PH_Poblado,]

leaflet() %>%
  addTiles() %>%
  addPolygons(data=PH_Poblado, col = "red") %>%
  addCircles(data=Pobladation)


######Definimos el área de chapinero
chapi_papi <- getbb(place_name = "UPZ Chapinero, Bogota", 
                    featuretype = "boundary:administrative", 
                    format_out = "sf_polygon") %>% .$multipolygon
#Dejamos con el mismo sistema de coordenadas

st_crs(chapi_papi)==st_crs(base_train_test$geometry)
chapi_papi <- st_transform(chapi_papi, crs=st_crs(base_train_test$geometry))

# Observaciones en chapinero
chapineration <- base_train_test[chapi_papi,]


leaflet() %>%
  addTiles() %>% 
  addPolygons(data=chapi_papi,color="red") %>% 
  addCircles(data=chapineration)


#Para bogotá vamos a agregar parques y universidades pensando 
# en que en esta zona vive población universitaria
######
transmi_rolos <- opq(bbox=getbb("Bogota Colombia")) %>%
  add_osm_feature(key="amenity", value ="bus_station")
transmi_rolos_sf <- osmdata_sf(transmi_rolos)
transmi_rolos_geom <- transmi_rolos_sf$osm_points

#Le ponemos el sistema de coordenadas de train
transmi_rolos_new <- st_transform(transmi_rolos_geom, crs=st_crs(train_nevera$geometry))

#Repetimos para universidades
universidades_rolas <- opq(bbox=getbb("Bogota Colombia")) %>%
  add_osm_feature(key="amenity", value ="university")
uni_rolas_sf <- osmdata_sf(universidades_rolas)
uni_rolas_geom <- uni_rolas_sf$osm_polygons

#Le ponemos el sistema de coordenadas de train
uni_rolas_new <- st_transform(uni_rolas_geom, crs=st_crs(train_nevera$geometry))


##Creamos el mapa en OSM para Bogotá
leaflet() %>% 
  addTiles()%>%
  addPolygons(data=uni_rolas_geom, col = "green") %>%
  addCircleMarkers(data = transmi_rolos_geom, col = "blue") %>%
  addCircles(data=train_nevera, col = "red")

####Distancia promedio a universidades de las casas
# Primero sacamos la distancia a una universidad

st_crs(uni_rolas_geom)
st_crs(train_nevera$geometry)
dist_uni <- st_distance(x=train_nevera$geometry, y=uni_rolas_new)
dist_uni

#ahora sacamos la distancia promedio
prom_dist_uni <- apply(dist_uni, 1, mean)
prom_dist_uni

#Pegamos a la base


####Distancia a una estación de transmilenio
dist_tra <- st_distance(x=train_nevera$geometry, y=transmi_rolos_new)
dist_tra

####Distancia mínima a una estación de transmileni
min_dist_tra <- apply(dist_uni, 1, mean)
min_dist_tra 






##El poblado en medellín es una zona rosa turística, por esta razón buscaremos cercanía a restaurantes
# y parques
restaurantes_paisas <- opq(bbox=getbb("Medellin Colombia")) %>%
  add_osm_feature(key="amenity", value ="restaurant")
restaurantes_paisas_sf <- osmdata_sf(restaurantes_paisas)
restaurantes_paisas_geom <- restaurantes_paisas_sf$osm_points

parques_paisas <- opq(bbox=getbb("Medellin Colombia")) %>%
  add_osm_feature(key="leisure", value ="park")
par_paisas_sf <- osmdata_sf(parques_paisas)
par_paisas_geom <- par_paisas_sf$osm_polygons


##Creamos el mapa en OSM para Medellín
leaflet() %>% 
  addTiles()%>%
  addPolygons(data=par_paisas_geom, col = "green") %>%
  addCircleMarkers(data = restaurantes_paisas_geom, col = "blue") %>%
  addCircles(data=train_medallo, col = "red")

###########################
#### Repetimos para la base test

test_medallo <- subset(test, test$l3=="Medellín")
test_nevera <- subset(test, test$l3=="Bogotá D.C")







#########Fin del script